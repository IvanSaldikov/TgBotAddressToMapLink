## Как развернуть на сервере

### Используем Docker

Как устанавливать и работать с Докером - тут https://www.youtube.com/watch?v=QF4ZF857m44

1. Push-им окончательную версию проекта на github.com
2. На Linux-подобной машине делаем git clone (или merge, если уже есть)
3. Собираем образ Docker-а на Докер-хабе:

https://hub.docker.com/repositories

`sudo docker build -t klezcool/yandex_bot ./`

где `klezcool` - это имя пользователя на Докер-Хабе (./ - это сборка из текущей директории).

`sudo docker push klezcool/yandex_bot` - отправляем на сервер (расшариваем)


#### Проверка работы образа

`sudo docker run --rm -d -e TELEGRAM_API_TOKEN=... -e YANDEX_API_KEY=... --name yb klezcool/yandex_bot` - 
запускаем...

`-d` - запуск в фоне (убрать для тестирования)

`--rm` - удалить контейнер после завершения

`-e` - задаем переменные окружения (необходимы для работы приложения)

`--name` - yb - имя контейнера, klezcool/yandex_bot - имя образа


#### На удаленном сервере - 1 (через Docker)

Основные команды: docker ps -a - отобразить все контейнеры (даже завершенные)

docker rmi X - удалить образ X

docker rm Y - удалить контейнер Y

`sudo docker pull klezcool/yandex_bot` - сначала забираем образ из удаленного репозитория.

Затем запускаем:
`sudo docker run --rm -d -e TELEGRAM_API_TOKEN=... -e YANDEX_API_KEY=... -v /home/www/code/tgbots/yandex_tg_bot/db:/db/ --name yb klezcool/yandex_bot`

`-d` - запуск в фоне (убрать для тестирования)

`--rm` - удалить контейнер после завершения

`-e` - задаем переменные окружения (необходимы для работы приложения)

`-v` - задает локальный каталог (в примере `/home/www/code/tgbots/yandex_tg_bot/db`), который монтируется в каталог конейнера - `/db/` в примере (нужно для сохранения баз данных)

`--name` - yb - имя контейнера, klezcool/yandex_bot - имя образа


#### На удаленном сервере - 2 (через Docker-compose)

Ножно создать отдельную папку и файл с именем `docker-compose.yaml` с содержанием:

```yaml
version: "3"
services:
  YandexTgBot:
    image: klezcool/yandex_bot
    restart: always
    volumes:
     - /home/www/code/tgbots/yandex_tg_bot/db:/home/db
    environment:
     - YANDEX_API_KEY=...
     - TELEGRAM_API_TOKEN=...
```
где

- `klezcool/yandex_bot` - название образа на Докер-хабе,

- `/home/www/code/tgbots/yandex_tg_bot/db` - абсолютный путь на сервере

- `/home/db` - абсолютный путь внутри контейнера - нужно для того, чтобы изменения в папке db сохранялись на сервере и мы не похерели данные.

Далее запускаем это всё из текущей папки командой:

`docker-compose up -d`

- `-d` - параметр для работы в фоне.

Если был запущен докер-образ через docker-compose, то нужно его сначала остановить, перейдя в папку и набрв


#### На удаленном сервере - 3 (через .sh файл)

Можно использовать приложенные sh-файлы для деплоймента, так как в них
уже есть все необходимые команды. Нужно поменять лишь пути, если необходимо.


Существуют два варианта деплоя кода приложения, в зависимости от того, откуда забирать код:
- github
- Dockerhub

`docker-compose.yaml` файл и `deploy.sh`-скрипт отличаются в этих случаях.
Поэтому они выделены в соответствующие папки в папке deploy.

##### Dockerhub

Перед загрузкой с Dockerhub-а необходимо запушить туда образ.
Для этого используется скрипт `push_to_dockerhub.sh` в папке `deploy/dockerhub`.

##### Github

В случае деплоя с гитхаба необходимо сначала запушить код на сам гитхаб (разумеется :).
После чего можно запускать `deploy.sh` из папки `github`.

`Working dir` в обоих версиях скрипта - это рабочая папка, т.е. папка
в которой находится файл `docker-compose.yaml` и из папки которого
запускается утилита `docker-compose`, которая и считывает 
этот файл настроект Docker-контейнеров.  